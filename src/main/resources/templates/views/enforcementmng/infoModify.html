<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">

	<div id="container-fluid">
		<!-- Page Heading -->
		<h1 id="detail-content-title" th:text="#{enforcement.infoModify.title}">교통단속 상세정보 수정</h1>

		<form id="frmInfoModify">
			<input type="hidden" name="tfcEnfId" th:value="${tfcEnfMaster.tfcEnfId}">
			<input type="hidden" name="vioId" class="vioId" th:value="${tfcEnfMaster.vioInfo.vioId}">
			<table class="detail-table">
				<colgroup>
					<col width="15%">
					<col width="35%">
					<col width="15%">
					<col width="35%">
				</colgroup>
				<tbody>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.enfInfo}">단속정보</span>
						</th>
						<td><input type="text" class="main-input data-validate tfcEnfTtl" th:value="${tfcEnfMaster.tfcEnfTtl}" th:data-valid-name="#{enforcement.infoDetail.enfInfo}" placeholder="Please Enter Enforcement Title" data-valid-required></td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.violationDate}">날짜</span>
						</th>
						<td>
							<input type="hidden" class="tfcEnfDt" th:value="${#dates.format(tfcEnfMaster.tfcEnfDt, 'yyyy-MM-dd HH:mm:ss')}">
							<input type="datetime-local" class="input-time data-validate" id="tfcEnfDt" th:data-valid-name="#{enforcement.infoDetail.violationDate}" th:value="${#dates.format(tfcEnfMaster.tfcEnfDt, 'yyyy-MM-dd HH:mm:ss')}" data-valid-required>
						</td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.licenseNumber}">라이선스 번호</span>
						</th>
						<td class="modal-find-line">
							<input type="text" class="main-input data-validate dvrLcenId" id="dvrLcenId" placeholder="Please Enter License Number" th:data-valid-name="#{enforcement.infoDetail.licenseNumber}" th:value="${tfcEnfMaster.vioInfo.dvrLcenId}" data-valid-required>
							<i class="search-icon" data-type="dvrLcenId" onclick="searchForApiData('show',this)"></i>	
						</td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.licenseTy}">라이선스 타입</span>
						</th>
						<td><input type="text" class="main-input data-validate dvrLcenTy" placeholder="Please Enter License Type" th:data-valid-name="#{enforcement.infoDetail.licenseTy}" th:value="${tfcEnfMaster.vioInfo.dvrLcenTy}" data-valid-required></td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.violatorsName}">운전자명</span>
						</th>
						<td class="modal-find-line">
							<input type="text" class="main-input data-validate vioNm" id="vioNm" placeholder="Please Enter Name" th:data-valid-name="#{enforcement.infoDetail.violatorsName}" th:value="${tfcEnfMaster.vioInfo.vioNm}" data-valid-required>
							<i class="search-icon" data-type="driverNm" onclick="searchForApiData('show',this)"></i>
						</td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.birthday}">생년월일</span>
						</th>
						<td><input type="text" class="main-input data-validate vioBrth" placeholder="Please Enter Birthday" th:data-valid-name="#{enforcement.infoDetail.birthday}" th:value="${tfcEnfMaster.vioInfo.vioBrth}" data-valid-required></td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.phone}">전화번호</span>
						</th>
						<td><input type="text" class="main-input data-validate vioPno" placeholder="Please Enter Phone" th:data-valid-name="#{enforcement.infoDetail.phone}" th:value="${tfcEnfMaster.vioInfo.vioPno}" data-valid-required></td>
						<th th:text="#{enforcement.infoDetail.email}">이메일</th>
						<td><input type="text" class="main-input data-validate vioEmail" placeholder="Please Enter Email" th:data-valid-name="#{enforcement.infoDetail.email}" th:value="${tfcEnfMaster.vioInfo.vioEmail}" data-valid-required></td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.vehiclType}">차량</span>
						</th>
						<td><input type="text" class="main-input data-validate vhTy" placeholder="Please Enter Classification" th:data-valid-name="#{enforcement.infoDetail.vehiclType}" th:value="${tfcEnfMaster.vhTy}" data-valid-required></td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.vehiclNo}">차량번호</span>
						</th>
						<td class="modal-find-line">
							<input type="text" class="main-input data-validate vhRegNo" id="vhRegNo" placeholder="Please Enter Vehicle Plate No." th:data-valid-name="#{enforcement.infoDetail.vehiclNo}" th:value="${tfcEnfMaster.vhRegNo}" data-valid-required>
							<i class="search-icon" onclick="searchForApiData('show',this)"></i>
						</td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.lawChoose}">위반 법령 선택</span>
						</th>
						<td class="modal-find-line">
							<select id="tfcLawId" class="filter-select filter98 data-validate" onchange="viewLwFineInfo(this)" th:data-valid-name="#{enforcement.infoDetail.lawChoose}" data-valid-required>
								<th:block th:each="item : ${trafficLawList}">
		                            <option th:value="${item.tfcLawId}" th:text="${item.lawNm}"></option>
								</th:block>
	                        </select>
						</td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.detectionRegist.addr}">위반자 주소</span>
						</th>
						<td>
							<input type="text" class="main-input data-validate vioAddr" id="vioAddr" placeholder="Please Enter Address" th:data-valid-name="#{enforcement.detectionRegist.addr}" th:value="${tfcEnfMaster.vioInfo.vioAddr}" data-valid-required>
						</td>
					</tr>
					<tr id="lawDetailChk" style="display:none;">
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.lawDetail}">법령 선택</span>
						</th>
						<td colspan="3">
							<input type="radio"><span id="lwDesc"></span><span id="lwPrice"></span>
							<button type="button">저장</button>
						</td>
					</tr>
					<tr>
					<tr id="lawDetail">
						<th>
							<span class="requiredMark">Illegal Law</span>
						</th>
						<td colspan="3">
							<th:block th:each="fineInfo : ${tfcEnfMaster.tfcLwFineInfoList}">
								<div class="lwChkInfoDiv">
									<p class="lwChkInfo" th:text="${fineInfo.fineDesc}" th:data-fine-value="${fineInfo.tfcLawFineId}" th:data-value="${fineInfo.tfcLawId}" th:data-price="${fineInfo.finePrice}"></p>
									<button type="button" class="delete-btn" onclick="deleteLwInfo(this)">Delete</button>
								</div>
							</th:block>
						</td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.fine}">범칙금</span>
						</th>
						<td colspan="3"><input type="text" class="main-input data-validate totalPrice" id="totalPrice" placeholder="Please Enter Penalty" th:data-valid-name="#{enforcement.infoDetail.fine}" th:value="${tfcEnfMaster.totalPrice}" readonly data-valid-required></td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.inforDetail.plcaePayment}">납부처</span>
						</th>
							<td colspan="3">
								<select id="placePymntId" class="filter-select placePymntId">
									<th:block th:each="item : ${placePaymentList}">
										<option th:value="${item.placePymntId}" th:text="${item.placePymntNm}" th:selected="${item.placePymntId == tfcEnfMaster.plPymntInfo?.placePymntId}"></option>
									</th:block>
								</select>
							</td>
						</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.polInCharge}">담당 경찰명</span>
						</th>
						<td class="modal-find-line">
							<input type="hidden" name="polId" th:value="${tfcEnfMaster.polInfo.polId}">
							<input type="text" class="main-input data-validate polNm" placeholder="Please Enter Officer" th:data-valid-name="#{enforcement.infoDetail.polInCharge}" th:value="${tfcEnfMaster.polInfo.polNm}" data-valid-required>
							<i class="search-icon" onclick="changeDeptListModal('show')"></i>
						</td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoDetail.polStationInCaharge}">관할 경찰서</span>
						</th>
						<td><input type="text" class="main-input polDeptNm" placeholder="Please Enter Police Station" th:value="${tfcEnfMaster.polInfo.polDeptNm}"></td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.infoModify.placeOfViolate}">위반장소</span>
						</th>
						<td colspan="3">
							<input type="text" class="main-input data-validate roadAddr" id="txtRoadAddr" placeholder="Please Enter Location" th:data-valid-name="#{enforcement.infoModify.placeOfViolate}" th:value="${tfcEnfMaster.roadAddr}" data-valid-required>
<!-- 							<i class="search-icon mapSearch"></i> -->
							<br><br>
							<div id="map" class="detailMap">
								<img src="/images/mapLocation_icon.png" alt="My Location" class="mapLocationIcon">
							</div>
						</td>
					</tr>
					<tr>
						<th>
							<span class="requiredMark" th:text="#{enforcement.detectionRegist.lat}">위도</span>
						</th>
						<td><input type="text" class="main-input data-validate lat" id="lat" name="lat" placeholder="Please Enter Latitude" th:data-valid-name="#{enforcement.detectionRegist.lat}" th:value="${tfcEnfMaster.lat}" data-valid-required></td>
						<th>
							<span class="requiredMark" th:text="#{enforcement.detectionRegist.lng}">경도</span>
						</th>
						<td><input type="text" class="main-input data-validate lng" id="lng" name="lng" placeholder="Please Enter Longitude" th:data-valid-name="#{enforcement.detectionRegist.lng}" th:value="${tfcEnfMaster.lng}" data-valid-required></td>
					</tr>
					<tr>
						<th th:text="#{enforcement.infoModify.tfcEnfDetail}">상세내용</th>
						<td colspan="3"><textarea class="detail-table-textarea tfcEnfDetail" id="txttfcEnfDetail" placeholder="Please Enter Details"
						th:text="${tfcEnfMaster.tfcEnfDetail}"></textarea></td>
					</tr>
					<tr>
						<th>Attachment</th>
						<td colspan="3">
							<input type="file" id="uploadFiles" name="uploadFiles" multiple/>
							<div id="dragArea">
								<div class="drag-area">
									<div class="dragText">
									   	File name cannot be more than 50 characters<br>
										The file size can only be uploaded under 5MB<br>
										Only WORD, XLSX, PDF, and ZIP file can be uploaded
									</div>
									<div>
										<input type="file" id="uploadFiles" onchange="addFiles(this);" multiple style="display: none;">
										<button type="button" onclick="fileDrag()" id="uploadBtn" class="main-btn">File Upload</button>
									</div>
								</div>
							</div>
							<div class="upload_wrap">
								<div id="upload_list_box">
									<th:block th:each="fileItem : ${tfcEnfMaster.tfcEnfFileInfoList}">
										<div class="upload_list">
											<div class="list_item input_same group_box flex-center">
					                			<div class="file_list" th:text="${fileItem.fileOrgNm}"></div>
						                		<button type="button" th:data-name="${fileItem.fileOrgNm}" th:data-value="${fileItem.vioFileNo}" class="fileDelBtn">
														<img src="/images/upload_close.png" alt="업로드파일 삭제">
						                		</button>
                							</div>
										</div>
									</th:block>
								</div>	
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</form>
		<div class="btn-wrap-center">
			<button type="button" id="btnGoList" class="sub-btn" onclick="javascript:window.history.back()"
			th:text="#{enforcement.infoModify.cancellation}">삭제</button>
			<div>
				<button type="button" id="btnModify" class="main-btn" th:text="#{enforcement.infoModify.save}">저장</button>	
			</div>
		</div>
	</div>
	
	<div class="modal-wrap" id="modal">

	</div>
</th:block>

</html>

<script th:inline="javascript">
	$("#btnimageModify").click(function () {
		if ($(this).attr('data-flag') == 'N') {
			$("#trImage").show();
			$(this).text("변경 취소");
			$(this).attr('data-flag', 'Y');
		} else if ($(this).attr('data-flag') == 'Y') {
			$("#trImage").hide();
			$(this).text("변경");
			$(this).attr('data-flag', 'N');
		}
	})

	var deleteFilesArr = new Array();
	let $fileInput = $("#uploadFiles");
	$(".fileDelBtn").on('click',function(){
        var $this = $(this);
        var fileNm = $this.data('name');
        var fileId = $this.data('value');
        const dataTransfer = new DataTransfer();
        let trans = $('#uploadFiles')[0].files;
        let fileArray = Array.from(trans);

        $this.closest('.upload_list').remove();
        fileArray.filter(file => file.name != fileNm).forEach(file => {
            dataTransfer.items.add(file);
        });
        $fileInput.prop('files',dataTransfer.files);
        
        let uploadLength = $('#upload_list_box').children('.upload_list').length;
		if(uploadLength <= 0){
			$('.upload_wrap').addClass('none');
		}
		deleteFilesArr.push(fileId);
    });
	
	$("#btnModify").click(function () {
		if($("#frmInfoModify").soValid()){
			var form = $("#frmInfoModify")[0];
			var data = new FormData(form);
			
			data.append("tfcEnfTtl", $(".tfcEnfTtl").val());
			data.append("tfcEnfDt", $(".tfcEnfDt").val());
			data.append("vhTy", $(".vhTy").val());
			data.append("vhRegNo", $(".vhRegNo").val());
			data.append("polId", $(".polId").val());
			data.append("roadAddr", $(".roadAddr").val());
			data.append("tfcEnfDetail", $(".tfcEnfDetail").val());
			data.append("totalPrice", $(".totalPrice").val());
			data.append("vioInfo.vioId", $(".vioId").val());
			data.append("vioInfo.dvrLcenId", $(".dvrLcenId").val());
			data.append("vioInfo.dvrLcenTy", $(".dvrLcenTy").val());
			data.append("vioInfo.vioAddr", $(".vioAddr").val());
			data.append("vioInfo.vioNm", $(".vioNm").val());
			data.append("vioInfo.vioBrth", $(".vioBrth").val());
			data.append("vioInfo.vioPno", $(".vioPno").val());
			data.append("vioInfo.vioEmail", $(".vioEmail").val());
			data.append("finePymntInfo.placePymntId", $(".placePymntId").val());
			
			var lwChkInfo = $(".lwChkInfo");
			$(lwChkInfo).each(function(index, value){
				data.append("tfcFineNtcInfoList[" + index + "].tfcLawFineId", $(this).data("fine-value"));
				data.append("tfcFineNtcInfoList[" + index + "].tfcLawId", $(this).data("value"));
				data.append("tfcFineNtcInfoList[" + index + "].tfcEnfPrice", $(this).data("price"));
			});
			
			// 기존 파일 정보 추가
			deleteFilesArr.forEach((value, index) => {
				data.append("tfcEnfFileInfoList[" + index + "].vioFileNo", value);
			})
			
			$.ajax({
				url: /*[[@{/enf/info/update.ajax}]]*/ "/enf/info/update.ajax",
				type: "post",
				enctype: 'multipart/form-data',
				data: data,
				processData: false,
				contentType: false,
				success: function (result) {
					if(result.code == 200){
						new ModalBuilder().init().successBody(result.message).footer(4,'확인',function(button, modal){
							modal.close();
							var baseUrl = /*[[@{/enf/info/detail.do}]]*/ '';
							window.location.href = baseUrl + "?tfcEnfId=" + [[${tfcEnfMaster.tfcEnfId}]];
						}).open();
					} else {
						new ModalBuilder().init().alertBoby(result.message).footer(4,'확인',function(button, modal){modal.close();}).open();
					}
				}
			});
		}
	})
	
	function viewLwFineInfo(_this){
		var tfcLawId = _this.value;
		$("#lawDetailChk td").empty();
		$.ajax({
            url: /*[[@{/enf/info/lwFineInfo.ajax}]]*/ "/enf/info/lwFineInfo.ajax",
            type: "post",
			dataType : "json",
			data :{
				"tfcLawId" : tfcLawId
			},
            success: function (result) {
				const lawFineInfoList = result.data;
				if(lawFineInfoList != null){
				$("#lawDetailChk td")
				$(".detail-law-div").removeClass("none");
					for(var i = 0; i < lawFineInfoList.length; i++){
						const tfcLawFineId = lawFineInfoList[i].tfcLawFineId;
						const tfcLawId = lawFineInfoList[i].tfcLawId;
						const fineDesc = lawFineInfoList[i].fineDesc;
						const finePrice = lawFineInfoList[i].finePrice;
						const finePriceStr = numberComma(lawFineInfoList[i].finePrice);
						
						html = '';
						html +=  '<div class="lawInfoList">';
						html += '<input type="radio" class="lwInfo" id="lwInfo'+i+'" name="lwInfo" data-fine-value="'+tfcLawFineId+'" data-value="'+tfcLawId+'" data-desc="'+fineDesc+'" data-price="'+finePrice+'">';
						html += '<label for="lwInfo" class="lawInfoText">'+fineDesc+' <span id="finePrice" class="lawInfoPrice">'+finePrice+'MT</span></label>';
						html += '<button type="button" class="main-btn lwInfoPlusBtn" onclick="saveLwFindInfo()">Add</button>';
						html +=  '</div>';
						
						
					}
						
						
						$("#lawDetailChk td").append(html);
				}
			}
    	})
		$("#lawDetailChk").show();
	}
	
	function saveLwFindInfo(){
		$(".lwInfo").each(function(){
			if($(this).is(":checked")){
				html = '';
				html += '<div class="lwChkInfoDiv">';
				html += '<p class="lwChkInfo" data-fine-value="'+$(this).data("fine-value")+'" data-value="'+$(this).data("value")+'" data-price="'+$(this).data("price")+'">'+$(this).data("desc")+'</p>';
				html += '<button type="button" class="delete-btn" onclick="deleteLwInfo(this)">Delete</button>';
				html += '</div>';
				$("#lawDetail td").append(html);
				
				fnSetTotalPrice();
			}
		});
	};
	
	function deleteLwInfo(_this){
		$(_this).parent(".lwChkInfoDiv").remove();
		fnSetTotalPrice();
	}
	
	function fnSetTotalPrice(){
		const tfcEnfPriceList = $(".lwChkInfo");
		
		if(tfcEnfPriceList.length == 0){
			$("#totalPrice").val(0);
			return false;
		}
        
        var totalPrice = 0;
		$(".lwChkInfo").each(function(){
			totalPrice += Number($(this).data("price"));
		})        
        
		$("#totalPrice").val(totalPrice);
	}

	function setThumbnail(event) {
		var reader = new FileReader();
		reader.onload = function (event) {
			var img = document.createElement("img");
			img.setAttribute('width', '900px');
			img.setAttribute('height', '300px');
			img.setAttribute("src", event.target.result);
			document.querySelector("div#image_container").appendChild(img);
		};
		reader.readAsDataURL(event.target.files[0]);
	}
	
	
	// 모달 수정 여부 확인필요?
	const modalContent = document.getElementById("modal");
	
	// modal control
	function changeDeptListModal(type) {

		if (type == "show") {
			$.ajax({
				url: '/modal/dept/list.ajax',
				type: "get",
				dataType: 'html',
				success: function (data) {
					modalContent.innerHTML += data;
					modalContent.style.display = 'block';
				}
			});
		} else if (type == "hide") {
			modalContent.innerHTML = '';
			modalContent.style.display = 'none';
		}

	}

	const lng = /*[[${tfcEnfMaster.lng}]]*/;
	const lat = /*[[${tfcEnfMaster.lat}]]*/;
	let map = new MozAtesMap({
		elementId : 'map',
		center_lng : lng,
		center_lat : lat,
		isInitDrawCenterMarker : true
	});
		
	$("#tfcEnfDt").on('change', function(){
	 	var value = this.value;
        var date = new Date(value);
        var formattedDateTime = formatDate(date);
        $(".tfcEnfDt").val(formattedDateTime);
	})
	
	//API Modal
	function searchForApiData(type , _this){
		let vhRegNo = document.getElementById('vhRegNo').value;
		let dvrLcenId = document.getElementById('dvrLcenId').value;
		let vioNm = document.getElementById('vioNm').value;
		
		let searchType = _this.getAttribute('data-type');
		let searchContent = '';
		
		switch(searchType){
			case 'dvrLcenId':
				searchContent = dvrLcenId;
			break;
			case 'vehicleNo':
				searchContent = vhRegNo;
			break;
			case 'driverNm':
				searchContent = vioNm;
			break;
		}
		
		if (type == "show") {
			$.ajax({
				url: `/common/modal/${searchType}/apiSearch.ajax`,
				data : {
					"searchContent" : searchContent
				},
				type: "get",
				dataType: 'html',
				success: function (data) {
					modalContent.innerHTML += data;
					modalContent.style.display = 'block';
					
					document.getElementById('searchBtn').addEventListener('click', function() {
				        const resultTable = document.getElementById('table_api_search');
				        
				        const searchType = document.getElementById('searchType').value;
				        const searchValue = document.getElementById('searchContent').value;
				        
				        if(searchType == null || searchType == '' || searchValue == null || searchValue == ''){
							alert("Please Input SearchType and SearchContent");
							return;
						}
				        
						const fetcher = new DriverSelectAPI();
				            fetcher.fetchData(searchType, searchValue, function(data) {
				                const tbody = document.getElementById('modalTbody');
				                tbody.empty();
				
				                data.forEach(item => {
				                    const tr = document.createElement('tr');
				                    tr.dataset.prop = JSON.stringify(item);
				                    tr.setAttribute('onclick','searchForApiData("hide",this)');
				                    tr.innerHTML = `
				                    	<td>${item.driverLicenseId}</td>
				                    	<td>${item.driverLicenseType}</td>
				                    	<td>${item.expirationDate}</td>
				                    	<td>${item.driverNm}</td>
				                    	<td>${item.driverBrth}</td>
				                    	<td>${item.driverPno}</td>
				                    	<td>${item.driverAddr}</td>
				                    	<td>${item.vehicleNo}</td>
				                    	<td>${item.vehicleType}</td>
				                    	`;
				                    tbody.appendChild(tr);
				                    
				                    resultTable.style.display = 'block';
				                });
				            });
				    });
				}
			});
		} else if (type == "hide") {
			const resultTable = document.getElementById('table_api_search');
			
			let objJsonStr = _this.dataset != null ? _this.dataset.prop : null;
			
			if(objJsonStr != null){
				const obj = JSON.parse(objJsonStr);
				console.log(obj);
				document.getElementById('dvrLcenId').value = obj.driverLicenseId;
				document.getElementById('dvrLcenTy').value = obj.driverLicenseType;
				document.getElementById('vioNm').value = obj.driverNm;
				document.getElementById('vioBrth').value = obj.driverBrth;
				document.getElementById('vioPno').value = obj.driverPno;
				document.getElementById('vioEmail').value = obj.driverEmail;
				document.getElementById('vioAddr').value = obj.driverAddr;
				document.getElementById('vhRegNo').value = obj.vehicleNo;
				document.getElementById('vhTy').value = obj.vehicleType;
			}
            resultTable.style.display = 'none';
            
			modalContent.innerHTML = '';
			modalContent.style.display = 'none';
		}
	}
</script>